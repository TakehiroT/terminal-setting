# テスト要件

## テスト戦略

- **カバレッジ目標**: 80%以上を目指す
- **重要な箇所は100%**: ビジネスロジック、セキュリティ関連コードは徹底的にテスト
- **カバレッジだけでなく品質**: 数値よりも意味のあるテストを優先

## TDD（テスト駆動開発）

### 基本サイクル

1. **Red**: 失敗するテストを書く
2. **Green**: テストを通す最小限の実装
3. **Refactor**: コードを改善

### TDD必須のケース

- 新機能開発
- バグ修正（再発防止のテスト）
- リファクタリング前の安全網

### TDDのメリット

- 設計の改善（テスタブルなコード）
- ドキュメントとしての役割
- リグレッション防止

## テストの種類と使い分け

### ユニットテスト

- **対象**: 関数、メソッド、クラス単位
- **特徴**: 高速、独立、大量に作成
- **ツール**: Vitest、Jest、Mocha
- **カバレッジ目標**: 関数レベルで80%以上

### 統合テスト

- **対象**: 複数のモジュール、API、データベース連携
- **特徴**: 実際の依存関係を使用
- **ツール**: Vitest、Jest、Supertest
- **カバレッジ目標**: 主要フロー100%

### E2Eテスト

- **対象**: ユーザー視点での全体動作
- **特徴**: ブラウザ自動化、遅い
- **ツール**: Playwright、Cypress、Puppeteer
- **カバレッジ目標**: クリティカルパス100%

## テストの原則

### FIRST原則

- **Fast**: 高速に実行できる
- **Independent**: 他のテストに依存しない
- **Repeatable**: 何度実行しても同じ結果
- **Self-validating**: 成功/失敗が自動判定される
- **Timely**: 適切なタイミング（TDDなら先に）で書く

### AAA（Arrange-Act-Assert）パターン

```typescript
test('ユーザーの年齢計算が正しい', () => {
  // Arrange: テストデータ準備
  const user = { birthDate: '1990-01-01' };

  // Act: テスト対象を実行
  const age = calculateAge(user);

  // Assert: 検証
  expect(age).toBe(34);
});
```

## モックの使用

### モックが必要なケース

- 外部API呼び出し
- データベースアクセス
- ファイルシステム操作
- 時刻依存のコード

### モックの注意点

- **最小限に**: 過度なモックはテストの価値を下げる
- **実装ではなく振る舞いをテスト**: 内部実装に依存しない
- **統合テストではモックを減らす**: 実際の依存関係でテスト

### モックツール

- `vi.mock()` (Vitest)
- `jest.mock()` (Jest)
- MSW (モックサーバー)

## テストの独立性

- **テスト間の依存を避ける**: 実行順序に関係なく成功
- **beforeEach/afterEach**: 各テスト前後でクリーンアップ
- **データベースのリセット**: トランザクションまたはテストDB使用
- **グローバル状態の回避**: テスト間で状態を共有しない

## テストの命名

```typescript
// Good: 何をテストしているか明確
test('空の配列の場合、合計は0を返す', () => { ... });
test('無効なメールアドレスの場合、エラーをスローする', () => { ... });

// Bad: 何をテストしているか不明
test('test1', () => { ... });
test('works', () => { ... });
```

## スナップショットテスト

- **UI コンポーネント**: React、Vueなどのレンダリング結果
- **注意点**: 無意識な変更を防ぐが、過度に使うとメンテナンスコストが高い
- **レビュー必須**: スナップショット変更は必ず人間が確認

## テストカバレッジの確認

```bash
# カバレッジレポート生成
pnpm test --coverage

# カバレッジ基準を設定
# vitest.config.ts
export default {
  test: {
    coverage: {
      lines: 80,
      functions: 80,
      branches: 80,
      statements: 80
    }
  }
}
```

## テストのメンテナンス

- **壊れたテストは即修正**: 無視されたテストは価値がない
- **リファクタリング時もテストを更新**: テストも生きたドキュメント
- **フレークテストの排除**: 不安定なテストは信頼性を損なう
